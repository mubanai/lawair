"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1760],{1760:(H,S,a)=>{a.r(S),a.d(S,{Tab3PageModule:()=>G});var g=a(4742),f=a(177),p=a(4341),M=a(1307),v=a(6244),d=a(467),t=a(4020),y=a(3656),T=a(1626),m=a(529);let C=(()=>{var s;class o{constructor(e,r){this.http=e,this.configService=r}generateSessionId(){var e;return console.log("===>"),this.http.post(`${null===(e=this.configService.config())||void 0===e?void 0:e.apiUrl}/start_session`,{})}getConversationMessages(e){var r;const n={participants:e};return this.http.post(`${null===(r=this.configService.config())||void 0===r?void 0:r.apiUrl}/api/v1/messages/getConversationMessages`,n)}sendMessage(e){var r;const n={...e};return this.http.post(`${null===(r=this.configService.config())||void 0===r?void 0:r.apiUrl}/rag-chat`,n)}uploadFileIndex(e){return this.http.post("localhost:5000/pass",e)}}return(s=o).\u0275fac=function(e){return new(e||s)(t.KVO(T.Qq),t.KVO(m.d))},s.\u0275prov=t.jDH({token:s,factory:s.\u0275fac,providedIn:"root"}),o})();var $=a(4412),P=a(9350),x=a(7707),R=a(5558),U=a(9437),F=a(8810),O=a(4796);let j=(()=>{var s;class o{constructor(e,r){var n;this.authService=e,this.configService=r,this.baseUrl="",this.isRefreshing=!1,this.refreshTokenSubject$=new $.t(null),this.baseUrl=`${null===(n=this.configService.config())||void 0===n?void 0:n.apiUrl}/`}fetchWithInterceptor(e,r){var n=this;return(0,d.A)(function*(){let i=n.authService.getUserToken();const c={...r.headers,Authorization:`Bearer ${i}`},h={...r,headers:c};let u=yield fetch(`${n.baseUrl}${e}`,h);return 401===u.status?n.handle401AndRetry(e,h):u})()}handle401AndRetry(e,r){var n=this;return(0,d.A)(function*(){if(n.isRefreshing)return new Promise(i=>{n.refreshTokenSubject$.subscribe(c=>{c&&i(n.retryFetch(e,r,c))})});n.isRefreshing=!0;try{return yield function I(s,o){const l="object"==typeof o;return new Promise((e,r)=>{const n=new x.Ms({next:i=>{e(i),n.unsubscribe()},error:r,complete:()=>{l?e(o.defaultValue):r(new P.G)}});s.subscribe(n)})}(n.authService.refreshToken().pipe((0,R.n)(c=>(n.isRefreshing=!1,n.refreshTokenSubject$.next(c.access_token),n.authService.setUserToken(c.access_token),n.retryFetch(e,r,c.access_token))),(0,U.W)(c=>(n.isRefreshing=!1,n.authService.logout(),(0,F.$)(()=>c)))))}catch(i){throw console.error("Token refresh failed:",i),n.isRefreshing=!1,i}})()}retryFetch(e,r,n){var i=this;return(0,d.A)(function*(){const c={...r,headers:{...r.headers,Authorization:`Bearer ${n}`}};return fetch(`${i.baseUrl}${e}`,c)})()}}return(s=o).\u0275fac=function(e){return new(e||s)(t.KVO(O.u),t.KVO(m.d))},s.\u0275prov=t.jDH({token:s,factory:s.\u0275fac,providedIn:"root"}),o})();const w=(s,o)=>({user:s,bot:o});function k(s,o){if(1&s&&(t.j41(0,"div",8)(1,"p"),t.EFF(2),t.k0s()()),2&s){const l=o.$implicit;t.Y8G("ngClass",t.l_i(2,w,l.isUser,!l.isUser)),t.R7$(2),t.JRh(l.text)}}function A(s,o){1&s&&(t.j41(0,"div",9),t.nrm(1,"ion-spinner",10),t.k0s())}const B=[{path:"",component:(()=>{var s;class o{constructor(e,r,n,i,c,h){this.navCtrl=e,this.conversationMessagesService=r,this.activatedRoute=n,this.loadingController=i,this.appService=c,this.fetchInterceptor=h,this.messages=[],this.newMessage="",this.loading=!1}ngOnInit(){var e=this;return(0,d.A)(function*(){yield(yield e.loadingController.create({spinner:"bubbles",cssClass:"custom-loader-class",showBackdrop:!1})).present(),yield e.loadingController.dismiss(),e.conversationMessagesService.generateSessionId().subscribe(n=>{n.session_id&&e.appService.setSessionId(n.session_id)},n=>{console.log("caught error {}",n)})})()}sendMessage(){var e=this;return(0,d.A)(function*(){e.newMessage.trim()&&(e.messages.push({text:e.newMessage,isUser:!0}),e.loading=!0,yield e.getStreamingResponse(e.newMessage),e.loading=!1,e.newMessage="")})()}getStreamingResponse(e){var r=this;return(0,d.A)(function*(){var n,i,c;const h={message:e,session_id:null!==(n=r.appService.getSessionId())&&void 0!==n?n:"",db_folder:"health_supplements",receiversIds:[null!==(i=null===(c=r.appService.getUserObj())||void 0===c?void 0:c.username)&&void 0!==i?i:""],userIsSender:!0,createdAt:new Date},u=yield r.fetchInterceptor.fetchWithInterceptor("rag-chat-stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...h})});if(!u.body)return console.error("Response body is empty"),"Error: No response from server";const D=u.body.getReader();let b="";const X=new TextDecoder;for(;;){const{done:V,value:Y}=yield D.read();if(V)break;b+=X.decode(Y,{stream:!0}),r.updateLastBotMessage(b)}return b})()}updateLastBotMessage(e){(!this.messages.length||this.messages[this.messages.length-1].isUser)&&this.messages.push({text:"",isUser:!1}),this.messages[this.messages.length-1].text=e}ngOnDestroy(){console.log("Getting destroyed the message component!!!")}}return(s=o).\u0275fac=function(e){return new(e||s)(t.rXU(y.q9),t.rXU(C),t.rXU(v.nX),t.rXU(g.Xi),t.rXU(m.d),t.rXU(j))},s.\u0275cmp=t.VBU({type:s,selectors:[["app-tab3"]],standalone:!1,decls:14,vars:3,consts:[[1,"chat-container"],[1,"chat-messages"],["class","chat-bubble",3,"ngClass",4,"ngFor","ngForOf"],["class","chat-bubble bot typing-indicator",4,"ngIf"],[1,"footer-bar"],["lines","none"],["placeholder","Type a message...",1,"chat-input",3,"ngModelChange","ngModel"],["expand","block","fill","solid","color","primary",3,"click"],[1,"chat-bubble",3,"ngClass"],[1,"chat-bubble","bot","typing-indicator"],["name","dots"]],template:function(e,r){1&e&&(t.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),t.EFF(3,"LawAIr"),t.k0s()()(),t.j41(4,"ion-content",0)(5,"div",1),t.DNE(6,k,3,5,"div",2)(7,A,2,0,"div",3),t.k0s()(),t.j41(8,"ion-footer",4)(9,"ion-toolbar")(10,"ion-item",5)(11,"ion-input",6),t.mxI("ngModelChange",function(i){return t.DH7(r.newMessage,i)||(r.newMessage=i),i}),t.k0s(),t.j41(12,"ion-button",7),t.bIt("click",function(){return r.sendMessage()}),t.EFF(13,"Send"),t.k0s()()()()),2&e&&(t.R7$(6),t.Y8G("ngForOf",r.messages),t.R7$(),t.Y8G("ngIf",r.loading),t.R7$(4),t.R50("ngModel",r.newMessage))},dependencies:[g.Jm,g.W9,g.M0,g.eU,g.$w,g.uz,g.w2,g.BC,g.ai,g.Gw,f.YU,f.Sq,f.bT,p.BC,p.vS],styles:[".chat-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding:15px}.chat-messages[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:10px}.chat-bubble[_ngcontent-%COMP%]{max-width:75%;padding:10px 15px;border-radius:18px;font-size:16px;word-wrap:break-word;box-shadow:0 2px 5px #0000001a}.user[_ngcontent-%COMP%]{align-self:flex-end;background:var(--ion-color-primary);color:#fff}.bot[_ngcontent-%COMP%]{align-self:flex-start;background:var(--ion-color-light);color:#000}.typing-indicator[_ngcontent-%COMP%]{display:flex;align-items:center;padding:5px 10px}.footer-bar[_ngcontent-%COMP%]{padding-bottom:env(safe-area-inset-bottom)}.chat-input[_ngcontent-%COMP%]{flex:1;margin-right:10px}"]}),o})()}];let E=(()=>{var s;class o{}return(s=o).\u0275fac=function(e){return new(e||s)},s.\u0275mod=t.$C({type:s}),s.\u0275inj=t.G2t({imports:[v.iI.forChild(B),v.iI]}),o})(),G=(()=>{var s;class o{}return(s=o).\u0275fac=function(e){return new(e||s)},s.\u0275mod=t.$C({type:s}),s.\u0275inj=t.G2t({imports:[g.bv,f.MD,p.YN,M.S,E]}),o})()}}]);