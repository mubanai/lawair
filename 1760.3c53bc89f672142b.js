"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1760],{1760:(H,S,a)=>{a.r(S),a.d(S,{Tab3PageModule:()=>E});var d=a(4742),f=a(177),p=a(4341),M=a(1307),v=a(6244),g=a(467),t=a(4020),y=a(3656),T=a(1626),m=a(529);let $=(()=>{var n;class o{constructor(e,s){this.http=e,this.configService=s}generateSessionId(){var e;return console.log("===>"),this.http.post(`${null===(e=this.configService.config())||void 0===e?void 0:e.apiUrl}/start_session`,{})}getConversationMessages(e){var s;const r={participants:e};return this.http.post(`${null===(s=this.configService.config())||void 0===s?void 0:s.apiUrl}/api/v1/messages/getConversationMessages`,r)}sendMessage(e){var s;const r={...e};return this.http.post(`${null===(s=this.configService.config())||void 0===s?void 0:s.apiUrl}/rag-chat`,r)}uploadFileIndex(e){return this.http.post("localhost:5000/pass",e)}}return(n=o).\u0275fac=function(e){return new(e||n)(t.KVO(T.Qq),t.KVO(m.d))},n.\u0275prov=t.jDH({token:n,factory:n.\u0275fac,providedIn:"root"}),o})();var C=a(4412),P=a(9350),x=a(7707),I=a(5558),U=a(9437),F=a(8810),O=a(4796);let j=(()=>{var n;class o{constructor(e,s){var r;this.authService=e,this.configService=s,this.baseUrl="",this.isRefreshing=!1,this.refreshTokenSubject$=new C.t(null),this.baseUrl=`${null===(r=this.configService.config())||void 0===r?void 0:r.apiUrl}/`}fetchWithInterceptor(e,s){var r=this;return(0,g.A)(function*(){let i=r.authService.getUserToken();const c={...s.headers,Authorization:`Bearer ${i}`},h={...s,headers:c};let u=yield fetch(`${r.baseUrl}${e}`,h);return 401===u.status?r.handle401AndRetry(e,h):u})()}handle401AndRetry(e,s){var r=this;return(0,g.A)(function*(){if(r.isRefreshing)return new Promise(i=>{r.refreshTokenSubject$.subscribe(c=>{c&&i(r.retryFetch(e,s,c))})});r.isRefreshing=!0;try{return yield function R(n,o){const l="object"==typeof o;return new Promise((e,s)=>{const r=new x.Ms({next:i=>{e(i),r.unsubscribe()},error:s,complete:()=>{l?e(o.defaultValue):s(new P.G)}});n.subscribe(r)})}(r.authService.refreshToken().pipe((0,I.n)(c=>(r.isRefreshing=!1,r.refreshTokenSubject$.next(c.access_token),r.authService.setUserToken(c.access_token),r.retryFetch(e,s,c.access_token))),(0,U.W)(c=>(r.isRefreshing=!1,r.authService.logout(),(0,F.$)(()=>c)))))}catch(i){throw console.error("Token refresh failed:",i),r.isRefreshing=!1,i}})()}retryFetch(e,s,r){var i=this;return(0,g.A)(function*(){const c={...s,headers:{...s.headers,Authorization:`Bearer ${r}`}};return fetch(`${i.baseUrl}${e}`,c)})()}}return(n=o).\u0275fac=function(e){return new(e||n)(t.KVO(O.u),t.KVO(m.d))},n.\u0275prov=t.jDH({token:n,factory:n.\u0275fac,providedIn:"root"}),o})();const w=(n,o)=>({user:n,bot:o});function k(n,o){if(1&n&&(t.j41(0,"div",8)(1,"p"),t.EFF(2),t.k0s()()),2&n){const l=o.$implicit;t.Y8G("ngClass",t.l_i(2,w,l.isUser,!l.isUser)),t.R7$(2),t.JRh(l.text)}}function A(n,o){1&n&&(t.j41(0,"div",9),t.nrm(1,"ion-spinner",10),t.k0s())}const G=[{path:"",component:(()=>{var n;class o{constructor(e,s,r,i,c,h){this.navCtrl=e,this.conversationMessagesService=s,this.activatedRoute=r,this.loadingController=i,this.appService=c,this.fetchInterceptor=h,this.messages=[],this.newMessage="",this.loading=!1}ngOnInit(){var e=this;return(0,g.A)(function*(){yield(yield e.loadingController.create({spinner:"bubbles",cssClass:"custom-loader-class",showBackdrop:!1})).present(),yield e.loadingController.dismiss(),e.conversationMessagesService.generateSessionId().subscribe(r=>{r.session_id&&e.appService.setSessionId(r.session_id)},r=>{console.log("caught error {}",r)})})()}sendMessage(){var e=this;return(0,g.A)(function*(){e.newMessage.trim()&&(e.loading=!0,e.messages.push({text:e.newMessage,isUser:!0}),yield e.getStreamingResponse(e.newMessage),e.loading=!1,e.newMessage="")})()}getStreamingResponse(e){var s=this;return(0,g.A)(function*(){var r,i,c;const h={message:e,session_id:null!==(r=s.appService.getSessionId())&&void 0!==r?r:"",db_folder:"health_supplements",receiversIds:[null!==(i=null===(c=s.appService.getUserObj())||void 0===c?void 0:c.username)&&void 0!==i?i:""],userIsSender:!0,createdAt:new Date},u=yield s.fetchInterceptor.fetchWithInterceptor("rag-chat-stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...h})});if(!u.body)return console.error("Response body is empty"),s.loading=!1,"Error: No response from server";const D=u.body.getReader();let b="";const X=new TextDecoder;for(;;){const{done:V,value:Y}=yield D.read();if(V)break;b+=X.decode(Y,{stream:!0}),s.updateLastBotMessage(b)}return b})()}updateLastBotMessage(e){(!this.messages.length||this.messages[this.messages.length-1].isUser)&&this.messages.push({text:"",isUser:!1}),this.messages[this.messages.length-1].text=e}ngOnDestroy(){console.log("Getting destroyed the message component!!!")}}return(n=o).\u0275fac=function(e){return new(e||n)(t.rXU(y.q9),t.rXU($),t.rXU(v.nX),t.rXU(d.Xi),t.rXU(m.d),t.rXU(j))},n.\u0275cmp=t.VBU({type:n,selectors:[["app-tab3"]],standalone:!1,decls:14,vars:4,consts:[[1,"chat-container"],[1,"chat-messages"],["class","chat-bubble",3,"ngClass",4,"ngFor","ngForOf"],["class","chat-bubble bot typing-indicator",4,"ngIf"],[1,"footer-bar"],["lines","none"],["placeholder","Type a message...",1,"chat-input",3,"ngModelChange","ngModel"],["expand","block","fill","solid","color","primary",3,"click","disabled"],[1,"chat-bubble",3,"ngClass"],[1,"chat-bubble","bot","typing-indicator"],["name","dots"]],template:function(e,s){1&e&&(t.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),t.EFF(3,"LawAIr"),t.k0s()()(),t.j41(4,"ion-content",0)(5,"div",1),t.DNE(6,k,3,5,"div",2)(7,A,2,0,"div",3),t.k0s()(),t.j41(8,"ion-footer",4)(9,"ion-toolbar")(10,"ion-item",5)(11,"ion-input",6),t.mxI("ngModelChange",function(i){return t.DH7(s.newMessage,i)||(s.newMessage=i),i}),t.k0s(),t.j41(12,"ion-button",7),t.bIt("click",function(){return s.sendMessage()}),t.EFF(13,"Send"),t.k0s()()()()),2&e&&(t.R7$(6),t.Y8G("ngForOf",s.messages),t.R7$(),t.Y8G("ngIf",s.loading),t.R7$(4),t.R50("ngModel",s.newMessage),t.R7$(),t.Y8G("disabled",s.loading))},dependencies:[d.Jm,d.W9,d.M0,d.eU,d.$w,d.uz,d.w2,d.BC,d.ai,d.Gw,f.YU,f.Sq,f.bT,p.BC,p.vS],styles:[".chat-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding:15px}.chat-messages[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:10px}.chat-bubble[_ngcontent-%COMP%]{max-width:75%;padding:10px 15px;border-radius:18px;font-size:16px;word-wrap:break-word;box-shadow:0 2px 5px #0000001a}.user[_ngcontent-%COMP%]{align-self:flex-end;background:var(--ion-color-primary);color:#fff}.bot[_ngcontent-%COMP%]{align-self:flex-start;background:var(--ion-color-light);color:#000}.typing-indicator[_ngcontent-%COMP%]{display:flex;align-items:center;padding:5px 10px}.footer-bar[_ngcontent-%COMP%]{padding-bottom:env(safe-area-inset-bottom)}.chat-input[_ngcontent-%COMP%]{flex:1;margin-right:10px}"]}),o})()}];let B=(()=>{var n;class o{}return(n=o).\u0275fac=function(e){return new(e||n)},n.\u0275mod=t.$C({type:n}),n.\u0275inj=t.G2t({imports:[v.iI.forChild(G),v.iI]}),o})(),E=(()=>{var n;class o{}return(n=o).\u0275fac=function(e){return new(e||n)},n.\u0275mod=t.$C({type:n}),n.\u0275inj=t.G2t({imports:[d.bv,f.MD,p.YN,M.S,B]}),o})()}}]);