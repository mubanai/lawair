"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1760],{1760:(J,M,i)=>{i.r(M),i.d(M,{Tab3PageModule:()=>D});var d=i(4742),f=i(177),v=i(4341),y=i(1307),m=i(6244),g=i(467),t=i(4020),T=i(3656),$=i(1626),b=i(529);let C=(()=>{var n;class o{constructor(e,s){this.http=e,this.configService=s}generateSessionId(){var e;return console.log("===>"),this.http.post(`${null===(e=this.configService.config())||void 0===e?void 0:e.apiUrl}/start_session`,{})}getConversationMessages(e){var s;const r={participants:e};return this.http.post(`${null===(s=this.configService.config())||void 0===s?void 0:s.apiUrl}/api/v1/messages/getConversationMessages`,r)}sendMessage(e){var s;const r={...e};return this.http.post(`${null===(s=this.configService.config())||void 0===s?void 0:s.apiUrl}/rag-chat`,r)}uploadFileIndex(e){return this.http.post("localhost:5000/pass",e)}}return(n=o).\u0275fac=function(e){return new(e||n)(t.KVO($.Qq),t.KVO(b.d))},n.\u0275prov=t.jDH({token:n,factory:n.\u0275fac,providedIn:"root"}),o})();var P=i(4412),x=i(9350),R=i(7707),U=i(5558),F=i(9437),O=i(8810),j=i(4796);let w=(()=>{var n;class o{constructor(e,s){var r;this.authService=e,this.configService=s,this.baseUrl="",this.isRefreshing=!1,this.refreshTokenSubject$=new P.t(null),this.baseUrl=`${null===(r=this.configService.config())||void 0===r?void 0:r.apiUrl}/`}fetchWithInterceptor(e,s){var r=this;return(0,g.A)(function*(){let a=r.authService.getUserToken();const c={...s.headers,Authorization:`Bearer ${a}`},h={...s,headers:c};let u=yield fetch(`${r.baseUrl}${e}`,h);return 401===u.status?r.handle401AndRetry(e,h):u})()}handle401AndRetry(e,s){var r=this;return(0,g.A)(function*(){if(r.isRefreshing)return new Promise(a=>{r.refreshTokenSubject$.subscribe(c=>{c&&a(r.retryFetch(e,s,c))})});r.isRefreshing=!0;try{return yield function I(n,o){const l="object"==typeof o;return new Promise((e,s)=>{const r=new R.Ms({next:a=>{e(a),r.unsubscribe()},error:s,complete:()=>{l?e(o.defaultValue):s(new x.G)}});n.subscribe(r)})}(r.authService.refreshToken().pipe((0,U.n)(c=>(r.isRefreshing=!1,r.refreshTokenSubject$.next(c.access_token),r.authService.setUserToken(c.access_token),r.retryFetch(e,s,c.access_token))),(0,F.W)(c=>(r.isRefreshing=!1,r.authService.logout(),(0,O.$)(()=>c)))))}catch(a){throw console.error("Token refresh failed:",a),r.isRefreshing=!1,a}})()}retryFetch(e,s,r){var a=this;return(0,g.A)(function*(){const c={...s,headers:{...s.headers,Authorization:`Bearer ${r}`}};return fetch(`${a.baseUrl}${e}`,c)})()}}return(n=o).\u0275fac=function(e){return new(e||n)(t.KVO(j.u),t.KVO(b.d))},n.\u0275prov=t.jDH({token:n,factory:n.\u0275fac,providedIn:"root"}),o})();const k=(n,o)=>({user:n,bot:o});function A(n,o){if(1&n&&(t.j41(0,"div",8)(1,"p"),t.EFF(2),t.k0s()()),2&n){const l=o.$implicit;t.Y8G("ngClass",t.l_i(2,k,l.isUser,!l.isUser)),t.R7$(2),t.JRh(l.text)}}function G(n,o){1&n&&(t.j41(0,"div",9),t.nrm(1,"ion-spinner",10),t.k0s())}const B=[{path:"",component:(()=>{var n;class o{constructor(e,s,r,a,c,h){this.navCtrl=e,this.conversationMessagesService=s,this.activatedRoute=r,this.loadingController=a,this.appService=c,this.fetchInterceptor=h,this.messages=[],this.newMessage="",this.loading=!1}ngOnInit(){var e=this;return(0,g.A)(function*(){yield(yield e.loadingController.create({spinner:"bubbles",cssClass:"custom-loader-class",showBackdrop:!1})).present(),yield e.loadingController.dismiss(),e.conversationMessagesService.generateSessionId().subscribe(r=>{r.session_id&&e.appService.setSessionId(r.session_id)},r=>{console.log("caught error {}",r)})})()}sendMessage(){var e=this;return(0,g.A)(function*(){e.loading=!0,e.newMessage.trim()&&(e.messages.push({text:e.newMessage,isUser:!0}),yield e.getStreamingResponse(e.newMessage),e.loading=!1,e.newMessage="")})()}getStreamingResponse(e){var s=this;return(0,g.A)(function*(){var r,a,c;const h={message:e,session_id:null!==(r=s.appService.getSessionId())&&void 0!==r?r:"",db_folder:"health_supplements",receiversIds:[null!==(a=null===(c=s.appService.getUserObj())||void 0===c?void 0:c.username)&&void 0!==a?a:""],userIsSender:!0,createdAt:new Date},u=yield s.fetchInterceptor.fetchWithInterceptor("rag-chat-stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...h})});if(!u.body)return console.error("Response body is empty"),s.loading=!1,"Error: No response from server";const X=u.body.getReader();let S="";const V=new TextDecoder("utf-8");for(;;){const{done:N,value:Y}=yield X.read();if(N)break;let p=V.decode(Y,{stream:!0});try{p=JSON.parse(p).message}catch{console.warn("Response not in JSON format",p)}S+=p,s.updateLastBotMessage(S)}return S})()}updateLastBotMessage(e){(!this.messages.length||this.messages[this.messages.length-1].isUser)&&this.messages.push({text:"",isUser:!1}),this.messages[this.messages.length-1].text=e}ngOnDestroy(){console.log("Getting destroyed the message component!!!")}}return(n=o).\u0275fac=function(e){return new(e||n)(t.rXU(T.q9),t.rXU(C),t.rXU(m.nX),t.rXU(d.Xi),t.rXU(b.d),t.rXU(w))},n.\u0275cmp=t.VBU({type:n,selectors:[["app-tab3"]],standalone:!1,decls:14,vars:4,consts:[[1,"chat-container"],[1,"chat-messages"],["class","chat-bubble",3,"ngClass",4,"ngFor","ngForOf"],["class","chat-bubble bot typing-indicator",4,"ngIf"],[1,"footer-bar"],["lines","none"],["placeholder","Type a message...",1,"chat-input",3,"ngModelChange","ngModel"],["expand","block","fill","solid","color","primary",3,"click","disabled"],[1,"chat-bubble",3,"ngClass"],[1,"chat-bubble","bot","typing-indicator"],["name","dots"]],template:function(e,s){1&e&&(t.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),t.EFF(3,"LawAIr"),t.k0s()()(),t.j41(4,"ion-content",0)(5,"div",1),t.DNE(6,A,3,5,"div",2)(7,G,2,0,"div",3),t.k0s()(),t.j41(8,"ion-footer",4)(9,"ion-toolbar")(10,"ion-item",5)(11,"ion-input",6),t.mxI("ngModelChange",function(a){return t.DH7(s.newMessage,a)||(s.newMessage=a),a}),t.k0s(),t.j41(12,"ion-button",7),t.bIt("click",function(){return s.sendMessage()}),t.EFF(13,"Send"),t.k0s()()()()),2&e&&(t.R7$(6),t.Y8G("ngForOf",s.messages),t.R7$(),t.Y8G("ngIf",s.loading),t.R7$(4),t.R50("ngModel",s.newMessage),t.R7$(),t.Y8G("disabled",s.loading))},dependencies:[d.Jm,d.W9,d.M0,d.eU,d.$w,d.uz,d.w2,d.BC,d.ai,d.Gw,f.YU,f.Sq,f.bT,v.BC,v.vS],styles:[".chat-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding:15px}.chat-messages[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:10px}.chat-bubble[_ngcontent-%COMP%]{max-width:75%;padding:10px 15px;border-radius:18px;font-size:16px;word-wrap:break-word;box-shadow:0 2px 5px #0000001a}.user[_ngcontent-%COMP%]{align-self:flex-end;background:var(--ion-color-primary);color:#fff}.bot[_ngcontent-%COMP%]{align-self:flex-start;background:var(--ion-color-light);color:#000}.typing-indicator[_ngcontent-%COMP%]{display:flex;align-items:center;padding:5px 10px}.footer-bar[_ngcontent-%COMP%]{padding-bottom:env(safe-area-inset-bottom)}.chat-input[_ngcontent-%COMP%]{flex:1;margin-right:10px}"]}),o})()}];let E=(()=>{var n;class o{}return(n=o).\u0275fac=function(e){return new(e||n)},n.\u0275mod=t.$C({type:n}),n.\u0275inj=t.G2t({imports:[m.iI.forChild(B),m.iI]}),o})(),D=(()=>{var n;class o{}return(n=o).\u0275fac=function(e){return new(e||n)},n.\u0275mod=t.$C({type:n}),n.\u0275inj=t.G2t({imports:[d.bv,f.MD,v.YN,y.S,E]}),o})()}}]);